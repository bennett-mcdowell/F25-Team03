name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: Frontend_Rework/package-lock.json
      
      - name: Build Frontend
        run: |
          cd Frontend_Rework
          npm ci
          npm run build
          cd ..
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        env:
          PORT: ${{ secrets.EC2_PORT }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          FRONTEND_URL: ${{ secrets.FRONTEND_URL }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: PORT,DB_HOST,DB_NAME,DB_USER,DB_PASSWORD,FRONTEND_URL
          script: |
            echo "Starting deployment..."
            
            # Pull latest code
            cd /home/ec2-user/F25-Team03
            git pull origin main
            
            # Install Python dependencies
            cd src
            pip3 install -r requirements.txt --quiet
            
            # Build Frontend on server (backup if GitHub Actions build fails)
            echo "Building frontend..."
            cd ../Frontend_Rework
            npm ci --quiet
            npm run build
            
            # Remove any old .env file (we use PM2 env vars instead)
            echo "Cleaning up old environment files..."
            rm -f ../src/Backend/.env
            
            # Insert deployment record
            echo "Inserting deployment record..."
            cd ../src/Backend
            
            # Run insert_deployment.py with environment variables
            DB_HOST="$DB_HOST" \
            DB_NAME="$DB_NAME" \
            DB_USER="$DB_USER" \
            DB_PASSWORD="$DB_PASSWORD" \
            python3 insert_deployment.py || echo "Warning: Failed to insert deployment record (continuing anyway)"
            
            # Create PM2 ecosystem file with environment variables
            echo "Creating PM2 ecosystem file..."
            cat > ecosystem.config.js << EOFCONFIG
            module.exports = {
              apps: [{
                name: 'flask-app',
                script: 'app.py',
                interpreter: 'python3',
                cwd: '/home/ec2-user/F25-Team03/src/Backend',
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                env: {
                  PORT: '$PORT',
                  DB_HOST: '$DB_HOST',
                  DB_NAME: '$DB_NAME',
                  DB_USER: '$DB_USER',
                  DB_PASSWORD: '$DB_PASSWORD',
                  FRONTEND_URL: '$FRONTEND_URL'
                },
                error_file: '/home/ec2-user/logs/flask-app-error.log',
                out_file: '/home/ec2-user/logs/flask-app.log',
                time: true
              }]
            };
            EOFCONFIG
            
            # Restart Flask app with PM2 using ecosystem file
            echo "Restarting application..."
            pm2 delete flask-app 2>/dev/null || true
            
            PORT="$PORT" \
            DB_HOST="$DB_HOST" \
            DB_NAME="$DB_NAME" \
            DB_USER="$DB_USER" \
            DB_PASSWORD="$DB_PASSWORD" \
            FRONTEND_URL="$FRONTEND_URL" \
            pm2 start ecosystem.config.js
            
            pm2 save
            
            echo "Deployment complete!"
            pm2 status
